<template>
  <div class="wrapper">
    <!-- flex布局 -->
    <!-- 内容主体 -->
    <div class="content">
      <!-- card -->
      <div class="content_card">
        <div class="card_wrapper" v-for="item in card" :key="item.id" :style="item.style">
          <div
            class="icon"
            :style="{
              background: 'url(' + item.img +') no-repeat',
              backgroundSize: 'cover',
            }"></div>
          <div class="c_content">
            <div class="titleText">
              {{ item.title }}
            </div>
            <div class="countNum">
              <div class="value">
                {{ item.value }}
              </div>
              <div class="unit">
                {{ item.unit }}
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- card end -->

      <!-- echarts pie -->
      <div class="content_pie_wrapper">
        <div class="pie level"></div>
        <div class="pie catogray"></div>
        <div class="pie total"></div>
      </div>
      <!-- echarts pie end -->

      <!-- echarts lines -->
      <div class="content_lines_wrapper">
        <div class="lines_title">
          <div class="titleTextTwo">漏洞修复走势</div>
          <div class="lines_tips">修复率</div>
          <div class="lines_tabBar">
            <div class="item" @click="toggleData">本周</div>
            <div class="item active" @click="toggleData1">本月</div>
          </div>
        </div>
        <div class="lines_content"></div>
      </div>
      <!-- <div class="bottonbox"></div> -->
      <!-- end -->
      <div class="tips_lines"></div>
    </div>
    <div class="bottonBar">
      <!-- <Tabbar /> -->
    </div>
  </div>
</template>

<script>
// import Tabbar from '@/components/Tabbar.vue';
import {
  card,
  level_option,
  catogray_option,
  total_option,
  lines_option_month,
  getPatchStat,
  getServerNum,
  getWeekRender,
  getMonthRender
} from './api.js'
import * as echarts from 'echarts'

export default {
  name: 'VulnerabilityMonitoring',
  data () {
    return {
      card: [],
      total_option: undefined,
      lines_option_month: undefined
    }
  },
  // components: {
  //   Tabbar,
  // },
  watch: {
    total_option: {
      handler () {
        this.$nextTick(() => {
          this.initCharts('.total', this.total_option)
        })
      },
      deep: true,
      immediate: true
    },
    'lines_option_month.xAxis.data': {
      handler () {
        this.$nextTick(() => {
          this.initCharts('.lines_content', this.lines_option_month)
        })
      },
      deep: true
    }
  },
  created () {
    this.card = card
    this.total_option = total_option
    this.lines_option_month = lines_option_month
  },
  mounted () {
    this.getPageData()
    this.initCharts('.level', level_option)
    this.initCharts('.catogray', catogray_option)
  },
  methods: {
    getPastDates (days) {
      const result = []

      for (let i = days - 1; i >= 0; i--) {
        const currentDate = new Date()
        currentDate.setDate(currentDate.getDate() - i)
        const year = currentDate.getFullYear()
        const month = String(currentDate.getMonth() + 1).padStart(2, '0')
        const day = String(currentDate.getDate()).padStart(2, '0')
        const formattedDate = `${year}-${month}-${day}`
        result.push(formattedDate)
      }

      return result
    },
    initCharts (eleClass, data) {
      const ele = document.querySelector(eleClass)
      // eslint-disable-next-line no-unused-expressions
      ele !== null ? ele.removeAttribute('_echarts_instance_') : ''
      let myEcharts = null
      let flag = false
      // 初始化 echarts 实例
      if (flag === false) {
        myEcharts = echarts.init(ele)
        flag = true
      }
      // 渲染图表
      myEcharts.setOption(data)
    },
    toggleData () {
      this.getWR()
      const activebtn = document.querySelectorAll('.active')
      // 去除所有选中样式
      const btnList = document.querySelectorAll('.lines_tabBar .item')
      for (const item of btnList) {
        item.classList.remove('active')
      }
      btnList[0].classList.add('active')
    },
    toggleData1 () {
      this.getMR()
      const activebtn = document.querySelectorAll('.active')
      // 去除所有选中样式
      const btnList = document.querySelectorAll('.lines_tabBar .item')
      for (const item of btnList) {
        item.classList.remove('active')
      }

      btnList[1].classList.add('active')
    },
    async getPageData () {
      // 顶部数据
      // 获取安全狗-漏洞总览
      const getPS = async () => {
        let data = await getPatchStat()
        if (data.data.data === undefined) {
          data = {
            data: {
              'code': 200,
              'msg': 'OK',
              'data': {
                'avgRepairedRate': '72.87%',
                'totalNum': 107371,
                'totalRepaired': 78236,
                'totalUnRepaired': 29135
              }
            }
          }
        }
        const {
          totalRepaired,
          totalUnRepaired,
          totalNum,
          avgRepairedRate
        } = data.data.data
        this.card[0].value = totalRepaired
        this.card[1].value = totalUnRepaired
        this.card[2].value = totalNum
        this.card[3].value = avgRepairedRate.replace(/%/g, '')// 去除百分号
      }
      getPS()
      // 获取安全狗-已经安装Agent数
      const getSN = async () => {
        const data = await getServerNum()
        let newData = null
        if (data.data.data === undefined) {
          newData = {
            'sourceCode': '5n7x4o',
            'serverNum': 1186,
            'sourceName': '10.201.20.11'
          }
        } else {
          newData = data.data.data[0]
        }
        this.total_option.series[0].data[0].value = newData.serverNum
        this.total_option.series[0].data[1].value = newData.serverNum
      }
      getSN()

      // 获取安全狗-月漏洞修复走势
      this.getMR()
    },
    // 获取安全狗-周漏洞修复走势
    async getWR () {
      const data1 = await getWeekRender()
      let newData = []
      const dataArr = this.getPastDates(7)
      if (data1.data.data === undefined) {
        newData = [{
          'unRepairedServerNum': '27452',
          'repairRate': '74.82',
          'startTime': dataArr[0],
          'endTime': '2023-07-01',
          'repairedServerNum': '81554',
          'effectServerNum': '109006'
        },
        {
          'unRepairedServerNum': '27452',
          'repairRate': '74.82',
          'startTime': dataArr[1],
          'endTime': '2023-07-02',
          'repairedServerNum': '81554',
          'effectServerNum': '109006'
        },
        {
          'unRepairedServerNum': '27195',
          'repairRate': '75.04',
          'startTime': dataArr[2],
          'endTime': '2023-07-03',
          'repairedServerNum': '81739',
          'effectServerNum': '108934'
        },
        {
          'unRepairedServerNum': '26834',
          'repairRate': '75.14',
          'startTime': dataArr[3],
          'endTime': '2023-07-04',
          'repairedServerNum': '81084',
          'effectServerNum': '107918'
        },
        {
          'unRepairedServerNum': '26473',
          'repairRate': '75.39',
          'startTime': dataArr[4],
          'endTime': '2023-07-05',
          'repairedServerNum': '81088',
          'effectServerNum': '107561'
        },
        {
          'unRepairedServerNum': '28495',
          'repairRate': '74.00',
          'startTime': dataArr[5],
          'endTime': '2023-07-06',
          'repairedServerNum': '81061',
          'effectServerNum': '109556'
        },
        {
          'unRepairedServerNum': '26497',
          'repairRate': '74.71',
          'startTime': dataArr[6],
          'endTime': '2023-07-07',
          'repairedServerNum': '78245',
          'effectServerNum': '104742'
        }
        ]
      } else {
        newData = data1.data.data
      }
      this.formatterData(newData)
    },
    // 获取安全狗-月漏洞修复走势
    async getMR () {
      const data = await getMonthRender()
      let newData = null
      const dataArr = this.getPastDates(30)
      if (data.data.data === undefined) {
        newData = [{
          'unRepairedServerNum': '28630',
          'repairRate': '73.38',
          'startTime': dataArr[0],
          'endTime': '2023-06-08',
          'repairedServerNum': '78887',
          'effectServerNum': '107517'
        },
        {
          'unRepairedServerNum': '28630',
          'repairRate': '73.38',
          'startTime': dataArr[1],
          'endTime': '2023-06-09',
          'repairedServerNum': '78887',
          'effectServerNum': '107517'
        },
        {
          'unRepairedServerNum': '28630',
          'repairRate': '73.38',
          'startTime': dataArr[2],
          'endTime': '2023-06-10',
          'repairedServerNum': '78887',
          'effectServerNum': '107517'
        },
        {
          'unRepairedServerNum': '28630',
          'repairRate': '73.38',
          'startTime': dataArr[3],
          'endTime': '2023-06-11',
          'repairedServerNum': '78887',
          'effectServerNum': '107517'
        },
        {
          'unRepairedServerNum': '28630',
          'repairRate': '73.38',
          'startTime': dataArr[4],
          'endTime': '2023-06-12',
          'repairedServerNum': '78887',
          'effectServerNum': '107517'
        },
        {
          'unRepairedServerNum': '28632',
          'repairRate': '93.37',
          'startTime': dataArr[5],
          'endTime': '2023-06-13',
          'repairedServerNum': '78885',
          'effectServerNum': '107517'
        },
        {
          'unRepairedServerNum': '28689',
          'repairRate': '73.34',
          'startTime': dataArr[6],
          'endTime': '2023-06-14',
          'repairedServerNum': '78890',
          'effectServerNum': '107579'
        },
        {
          'unRepairedServerNum': '30035',
          'repairRate': '72.73',
          'startTime': dataArr[7],
          'endTime': '2023-06-15',
          'repairedServerNum': '80101',
          'effectServerNum': '110136'
        },
        {
          'unRepairedServerNum': '30035',
          'repairRate': '72.73',
          'startTime': dataArr[8],
          'endTime': '2023-06-16',
          'repairedServerNum': '80101',
          'effectServerNum': '110136'
        },
        {
          'unRepairedServerNum': '30035',
          'repairRate': '72.73',
          'startTime': dataArr[9],
          'endTime': '2023-06-17',
          'repairedServerNum': '80101',
          'effectServerNum': '110136'
        },
        {
          'unRepairedServerNum': '30035',
          'repairRate': '72.73',
          'startTime': dataArr[10],
          'endTime': '2023-06-18',
          'repairedServerNum': '80101',
          'effectServerNum': '110136'
        },
        {
          'unRepairedServerNum': '31338',
          'repairRate': '71.55',
          'startTime': dataArr[11],
          'endTime': '2023-06-19',
          'repairedServerNum': '78810',
          'effectServerNum': '110148'
        },
        {
          'unRepairedServerNum': '31085',
          'repairRate': '71.76',
          'startTime': dataArr[12],
          'endTime': '2023-06-20',
          'repairedServerNum': '78979',
          'effectServerNum': '110064'
        },
        {
          'unRepairedServerNum': '30759',
          'repairRate': '72.06',
          'startTime': dataArr[13],
          'endTime': '2023-06-21',
          'repairedServerNum': '79305',
          'effectServerNum': '110064'
        },
        {
          'unRepairedServerNum': '30759',
          'repairRate': '72.06',
          'startTime': dataArr[14],
          'endTime': '2023-06-22',
          'repairedServerNum': '79305',
          'effectServerNum': '110064'
        },
        {
          'unRepairedServerNum': '30759',
          'repairRate': '72.06',
          'startTime': dataArr[15],
          'endTime': '2023-06-23',
          'repairedServerNum': '79305',
          'effectServerNum': '110064'
        },
        {
          'unRepairedServerNum': '30759',
          'repairRate': '72.06',
          'startTime': dataArr[16],
          'endTime': '2023-06-24',
          'repairedServerNum': '79305',
          'effectServerNum': '110064'
        },
        {
          'unRepairedServerNum': '30747',
          'repairRate': '72.07',
          'startTime': dataArr[17],
          'endTime': '2023-06-25',
          'repairedServerNum': '79305',
          'effectServerNum': '110052'
        },
        {
          'unRepairedServerNum': '30193',
          'repairRate': '72.45',
          'startTime': dataArr[18],
          'endTime': '2023-06-26',
          'repairedServerNum': '79361',
          'effectServerNum': '109554'
        },
        {
          'unRepairedServerNum': '30193',
          'repairRate': '72.45',
          'startTime': dataArr[19],
          'endTime': '2023-06-27',
          'repairedServerNum': '79361',
          'effectServerNum': '109554'
        },
        {
          'unRepairedServerNum': '27562',
          'repairRate': '74.70',
          'startTime': dataArr[20],
          'endTime': '2023-06-28',
          'repairedServerNum': '81372',
          'effectServerNum': '108934'
        },
        {
          'unRepairedServerNum': '27562',
          'repairRate': '74.70',
          'startTime': dataArr[21],
          'endTime': '2023-06-29',
          'repairedServerNum': '81372',
          'effectServerNum': '108934'
        },
        {
          'unRepairedServerNum': '27452',
          'repairRate': '74.82',
          'startTime': dataArr[22],
          'endTime': '2023-06-30',
          'repairedServerNum': '81554',
          'effectServerNum': '109006'
        },
        {
          'unRepairedServerNum': '27452',
          'repairRate': '74.82',
          'startTime': dataArr[23],
          'endTime': '2023-07-01',
          'repairedServerNum': '81554',
          'effectServerNum': '109006'
        },
        {
          'unRepairedServerNum': '27452',
          'repairRate': '74.82',
          'startTime': dataArr[24],
          'endTime': '2023-07-02',
          'repairedServerNum': '81554',
          'effectServerNum': '109006'
        },
        {
          'unRepairedServerNum': '27195',
          'repairRate': '75.04',
          'startTime': dataArr[25],
          'endTime': '2023-07-03',
          'repairedServerNum': '81739',
          'effectServerNum': '108934'
        },
        {
          'unRepairedServerNum': '26834',
          'repairRate': '75.14',
          'startTime': dataArr[26],
          'endTime': '2023-07-04',
          'repairedServerNum': '81084',
          'effectServerNum': '107918'
        },
        {
          'unRepairedServerNum': '26473',
          'repairRate': '75.39',
          'startTime': dataArr[27],
          'endTime': '2023-07-05',
          'repairedServerNum': '81088',
          'effectServerNum': '107561'
        },
        {
          'unRepairedServerNum': '28495',
          'repairRate': '74.00',
          'startTime': dataArr[28],
          'endTime': '2023-07-06',
          'repairedServerNum': '81061',
          'effectServerNum': '109556'
        },
        {
          'unRepairedServerNum': '26497',
          'repairRate': '74.71',
          'startTime': dataArr[29],
          'endTime': '2023-07-07',
          'repairedServerNum': '78245',
          'effectServerNum': '104742'
        }
        ]
      } else {
        newData = data.data.data
      }
      this.formatterData(newData)
    },
    formatterData (newData) {
      this.lines_option_month.xAxis.data = newData.map((item) => item.startTime)
      this.lines_option_month.series[0].data = newData.map((item) => item.repairRate)
    },
    handleBack () {
      // console.log('back');
      this.$router.back()
    }
  }
}
</script>

<style lang='less' scoped>
@media screen and (min-width: 128px) {
  .wrapper {
    width: 82vw ;
    height: 100%;
    background: rgba(255, 255, 255, 1);
    border: 1px solid;
    border-image: linear-gradient(180deg, rgba(255, 255, 255, 1), rgba(255, 255, 255, 1)) 1 1;
    padding: 28px 37px 68px 37px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    overflow: scroll;

    .wrapper_top {
      height: 35px;
      width: 100%;
      display: flex;
      justify-content: flex-start;
      align-items: center;
    }

    .wrapper_title {
      height: 35px;
      font-size: 23px;
      font-family: PingFangSC-Semibold, PingFang SC;
      font-weight: 600;
      color: #000000;
      height: 35px;
      display: flex;
    }

    // .back {
    //   width: 31px;
    //   height: 31px;
    //   background: url('@/assets/images/security/icon_exit.png') no-repeat center;
    //   background-size: cover;
    //   margin-left: auto;
    // }

    .content {
      margin-top: 14px;
      flex: 1;
      display: flex;
      flex-direction: column;

      // card
      .content_card {
        height: 92px;
        display: flex;
        justify-content: space-between;

        .card_wrapper {
          width: 270px;
          height: 92px;
          box-sizing: border-box;
          padding: 15px 0 0 34px;
          margin-right: 42px;

          background: linear-gradient(135deg, #19d98b 0%, #138182 100%);
          border-radius: 8px;

          &:nth-last-child(1) {
            margin-right: 0;
          }

          display: flex;

          .icon {
            width: 62.91px;
            height: 76.67px;
            margin-right: 26px;
          }

          .c_content {
            display: flex;
            flex-direction: column;
            margin-top: 3.5px;

            .titleText {
              height: 13px;
              font-size: 12px;
              font-family: MicrosoftYaHei;
              color: #ffffff;
              line-height: 13px;
              margin-bottom: 17px;
              text-align: center;
            }

            .countNum {
              display: flex;
              align-items: flex-end;

              // ------------------------------------------------------------------------
              .value {
                height: 25px;
                font-size: 25px;
                font-family: PingFangSC-Semibold, PingFang SC;
                font-weight: 600;
                color: #ffffff;
                line-height: 25px;
                margin-right: 7.8px;
                display: flex;
              }

              .unit {
                width: 12px;
                height: 12px;
                font-size: 12px;
                font-family: MicrosoftYaHei;
                color: #ffffff;
                line-height: 7px;
                margin-bottom: 5px;
              }
            }
          }
        }
      }

      // pie
      .content_pie_wrapper {
        width: 100%;
        height: 243px;
        // margin: 40px 0 20px 0;
        display: flex;

        .pie {
          flex: 1 1 33.33%;
          height: 100%;
        }
      }

      // lines
      .content_lines_wrapper {

        display: flex;
        height: 289px;
        flex-direction: column;

        .lines_title {
          height: 24px;
          display: flex;

          .titleTextTwo {
            width: 108px;
            height: 18px;
            font-size: 18px;
            font-family: PingFangSC-Semibold, PingFang SC;
            font-weight: 600;
            color: rgba(0, 96, 163, 1);
            line-height: 18px;
            margin-right: 31px;
            margin-top: 3px;
          }

          .lines_tips {
            position: relative;
            width: 45px;
            height: 18px;
            font-size: 15px;
            font-family: PingFangSC-Regular, PingFang SC;
            font-weight: 400;
            color: rgba(0, 0, 0, 0.7);
            line-height: 18px;
            margin-left: 18.5px;
            margin-top: 3px;

            &::before {
              content: '';
              display: block;
              position: absolute;
              width: 13px;
              height: 13px;
              border-radius: 50%;
              background: #0b99ff;
              top: 2.5px;

              margin: auto;
              left: -18.5px;
            }
          }

          .lines_tabBar {
            margin-left: 803.5px;
            display: flex;

            .item {
              position: relative;
              width: 88px;
              height: 24px;
              text-align: center;
              line-height: 24px;
              font-size: 16px;
              font-family: PingFangSC-Regular, PingFang SC;
              color: rgba(0, 150, 255, 1);
              border: 1px solid rgba(0, 150, 255, 1);
              rgba(0, 150, 255, 1)
              &:nth-child(1) {
                margin-right: 14px;
              }

              // 扩大按钮点击范围
              &::after {
                content: '';
                position: absolute;
                left: -5px;
                right: -5px;
                top: -5px;
                bottom: -5px;
              }
            }

            .active {
              background: rgba(0, 150, 255, 1);
              color: #0e263e;
            }
          }
        }

        .lines_content {
          // min-height: 157px;
          position: relative;
          top: 2px;
          right: 7.5px;
          flex: 1;
          width: 100%;
        }
      }

      .tips_lines {
        display: none;
        height: 16px;
        background: #153e68;
        border: 1px solid #3b6f9f;
        margin-top: 7.62px;
      }
    }

    .bottonBar {
      height: 68px;
    }
  }
}

.bottonbox {
  width: 1153px;
  height: 28px;
  // max-height:28px ;
  background: #153E68;
  border: 1px solid #3B6F9F;
  margin-left: 25.7px;
  position: relative;
  // flex: 1;
  display: flex;
  align-items: center; // 垂直居中对齐内容
  &::before {
    content: "";
    position: absolute;
    width: 0.6%;
    height: 53.6%;
    background-color: #64B2FF;
    left: 0%;
    transform: translateX(-50%);
  }

  &::after {
    content: "";
    position: absolute;
    width: 0.6%;
    height: 53.6%;
    background-color: #64B2FF;
    right: 0%;
    transform: translateX(50%);
  }
}
</style>
